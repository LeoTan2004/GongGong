package main

var (
	CalHTML = "<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no\">\n    <title>课程日历下载</title>\n    <style>\n\n        .user-info {\n            position: absolute;\n            top: 20px;\n            right: 20px;\n            display: flex;\n            align-items: center;\n            gap: 10px;\n        }\n\n        #usernameDisplay {\n            font-size: 1rem;\n            color: #333;\n        }\n\n        #logoutButton {\n            padding: 8px 16px;\n            background-color: #ff3b30;\n            color: white;\n            border: none;\n            border-radius: 8px;\n            cursor: pointer;\n            font-size: 14px;\n        }\n\n        #logoutButton:hover {\n            background-color: #ff1a1a;\n        }\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, Helvetica, Arial, sans-serif;\n            margin: 0;\n            padding: 20px;\n            background-color: #f5f5f7;\n        }\n\n        .container {\n            max-width: 500px;\n            margin: 0 auto;\n        }\n\n        .title {\n            text-align: center;\n            font-size: 2rem;\n            font-weight: bold;\n            color: #333;\n            margin-bottom: 2rem;\n        }\n\n        .login-form {\n            background: white;\n            padding: 2rem;\n            border-radius: 12px;\n            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n        }\n\n        .download-section {\n            display: none;\n            margin-top: 2rem;\n        }\n\n        input {\n            width: 100%;\n            padding: 12px;\n            margin: 8px 0;\n            border: 1px solid #ddd;\n            border-radius: 8px;\n            box-sizing: border-box;\n        }\n\n        button {\n            width: 100%;\n            padding: 14px;\n            background-color: #007AFF;\n            color: white;\n            border: none;\n            border-radius: 8px;\n            font-size: 16px;\n            margin-top: 1rem;\n            cursor: pointer;\n        }\n\n        .download-link {\n            display: block;\n            padding: 16px;\n            background: white;\n            border-radius: 8px;\n            margin: 10px 0;\n            text-decoration: none;\n            color: #007AFF;\n            text-align: center;\n            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n        }\n\n        .error-message {\n            color: #ff3b30;\n            margin-top: 1rem;\n            text-align: center;\n        }\n\n        @media (min-width: 768px) {\n            .container {\n                padding: 40px 0;\n            }\n        }\n\n    </style>\n</head>\n<body>\n<div class=\"container\">\n    <div class=\"user-info\" id=\"userInfo\">\n        <button id=\"logoutButton\" style=\"display: none\">登出</button>\n    </div>\n    <div class=\"title\">拱拱</div>\n    <div class=\"login-form\">\n        <h2>用户登录</h2>\n        <form id=\"loginForm\">\n            <input type=\"text\" id=\"username\" placeholder=\"用户名\" required>\n            <input type=\"password\" id=\"password\" placeholder=\"密码\" required>\n            <button type=\"submit\">登录</button>\n        </form>\n        <div id=\"errorMessage\" class=\"error-message\"></div>\n    </div>\n\n    <div class=\"download-section\" id=\"downloadSection\">\n        <a href=\"#\" class=\"download-link\" id=\"courseCalendar\">下载课程日历</a>\n        <a href=\"#\" class=\"download-link\" id=\"examCalendar\">下载考试日历</a>\n    </div>\n</div>\n\n<script>\n    let accessToken = localStorage.getItem('access_token');\n    let username = localStorage.getItem('username');\n\n    // 自动检测登录状态\n    if (accessToken) {\n        showDownloadSection();\n        document.getElementById('usernameDisplay').textContent = username;\n        document.getElementById('userInfo').style.display = 'flex';\n    }\n\n    document.getElementById('loginForm').addEventListener('submit', async (e) => {\n        e.preventDefault();\n\n        const username = document.getElementById('username').value;\n        const password = document.getElementById('password').value;\n\n        try {\n            const response = await fetch(`../login`, {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/x-www-form-urlencoded',\n                },\n                body: new URLSearchParams({\n                    username,\n                    password,\n                    grant_type: 'password' // OAuth2密码模式\n                })\n            });\n\n            if (!response.ok) throw new Error('登录失败');\n\n            const data = await response.json();\n            accessToken = data.access_token;\n            localStorage.setItem('access_token', accessToken);\n            localStorage.setItem('username', username);\n            showDownloadSection();\n            document.getElementById('userInfo').style.display = 'flex';\n            document.getElementById('errorMessage').textContent = '';\n        } catch (error) {\n            document.getElementById('errorMessage').textContent = '用户名或密码错误';\n        }\n    });\n\n    document.getElementById('logoutButton').addEventListener('click', () => {\n        localStorage.removeItem('access_token');\n        localStorage.removeItem('username');\n        accessToken = null;\n        document.getElementById('userInfo').style.display = 'none';\n        document.querySelector('.login-form').style.display = 'block';\n        document.getElementById('downloadSection').style.display = 'none';\n    });\n\n    function showDownloadSection() {\n        document.querySelector('.login-form').style.display = 'none';\n        document.getElementById('downloadSection').style.display = 'block';\n        document.getElementById('logoutButton').style.display = 'block';\n    }\n\n    // 通用下载处理函数\n    async function handleDownload(type) {\n        let response\n        for (let i = 0; i < 5; i++) {\n            response = await fetch(`../icalendar/${type}`, {\n                headers: {\n                    'Authorization': `Bearer ${accessToken}`\n                }\n            });\n            switch (response.status) {\n                case 200:\n                    break;\n                case 203:\n                    await sleep(1000);\n                    break\n                default:\n                    throw new Error('下载失败');\n            }\n        }\n        const blob = await response.blob();\n        const url = window.URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = `${type}-calendar.ics`;\n        document.body.appendChild(a);\n        a.click();\n        window.URL.revokeObjectURL(url);\n        document.body.removeChild(a);\n\n    }\n\n    const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));\n    document.getElementById('courseCalendar').addEventListener('click', (e) => {\n        e.preventDefault();\n        for (let i = 0; i < 3; i++) {\n            try {\n                handleDownload('courses');\n                break;\n            } catch (error) {\n                sleep(1000);\n            }\n        }\n    });\n\n    document.getElementById('examCalendar').addEventListener('click', (e) => {\n        e.preventDefault();\n        for (let i = 0; i < 3; i++) {\n            try {\n                handleDownload('exams');\n                break;\n            } catch (error) {\n                sleep(1000);\n            }\n        }\n    });\n</script>\n</body>\n</html>\n"
)
var (
	CalBytes = []byte(CalHTML)
)
